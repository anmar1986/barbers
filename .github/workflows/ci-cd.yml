name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  # Security scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run security checker
        uses: symfonycorp/security-checker-action@v5
        continue-on-error: true

  # Code quality checks
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer:v2

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.json') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Run Laravel Pint (dry-run)
        run: vendor/bin/pint --test
        continue-on-error: true

      - name: Run PHPStan
        run: composer phpstan
        continue-on-error: true

  # Frontend quality checks
  frontend-quality:
    name: Web Frontend Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint
        continue-on-error: true

  # Flutter quality checks
  flutter-quality:
    name: Flutter Mobile Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'
          cache: true

      - name: Get Flutter dependencies
        working-directory: frontend
        run: flutter pub get

      - name: Run Flutter Analyze
        working-directory: frontend
        run: flutter analyze

      - name: Check Flutter formatting
        working-directory: frontend
        run: dart format --set-exit-if-changed .
        continue-on-error: true

  # Run tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [security, code-quality, frontend-quality, flutter-quality]
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: testing
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, dom, fileinfo, pdo_mysql
          tools: composer:v2
          coverage: xdebug

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.json') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install PHP dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Install Node dependencies
        run: npm ci

      - name: Copy environment file
        run: php -r "if (!file_exists('.env')) copy('.env.example', '.env');"

      - name: Generate application key
        run: php artisan key:generate

      - name: Configure database
        run: |
          echo "DB_CONNECTION=mysql" >> .env
          echo "DB_HOST=127.0.0.1" >> .env
          echo "DB_PORT=3306" >> .env
          echo "DB_DATABASE=testing" >> .env
          echo "DB_USERNAME=root" >> .env
          echo "DB_PASSWORD=password" >> .env

      - name: Wait for MySQL
        run: |
          echo 'Waiting for MySQL to be ready...'
          for i in {1..30}; do
            if mysqladmin ping -h "127.0.0.1" -P "3306" --silent; then
              echo 'MySQL is ready.'
              exit 0
            fi
            sleep 1
          done
          echo 'MySQL did not become ready in time.'
          exit 1

      - name: Run migrations
        run: php artisan migrate --force

      - name: Build frontend
        run: npm run build

      - name: Run tests with coverage
        run: ./vendor/bin/phpunit --coverage-clover coverage.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  # Build and prepare for deployment
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer:v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader
          npm ci

      - name: Build assets
        run: npm run build

      - name: Create deployment artifact
        run: |
          mkdir -p deployment
          tar -czf deployment/app.tar.gz \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='.github' \
            --exclude='deployment' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-build
          path: deployment/app.tar.gz
          retention-days: 5

  # Deploy to staging (when pushing to develop branch)
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    # Uncomment and configure environment when ready to deploy
    # environment:
    #   name: staging
    #   url: https://staging.yourdomain.com
    
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: app-build

      # Add your staging deployment steps here
      # Example for SSH deployment:
      # - name: Deploy to staging server
      #   uses: easingthemes/ssh-deploy@main
      #   env:
      #     SSH_PRIVATE_KEY: ${{ secrets.STAGING_SSH_KEY }}
      #     REMOTE_HOST: ${{ secrets.STAGING_HOST }}
      #     REMOTE_USER: ${{ secrets.STAGING_USER }}
      #     TARGET: /var/www/staging

      - name: Deployment placeholder
        run: echo "Add your staging deployment steps here"

  # Deploy to production (when pushing to main branch)
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    # Uncomment and configure environment when ready to deploy
    # environment:
    #   name: production
    #   url: https://yourdomain.com
    
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: app-build

      # Add your production deployment steps here
      # Example for SSH deployment:
      # - name: Deploy to production server
      #   uses: easingthemes/ssh-deploy@main
      #   env:
      #     SSH_PRIVATE_KEY: ${{ secrets.PRODUCTION_SSH_KEY }}
      #     REMOTE_HOST: ${{ secrets.PRODUCTION_HOST }}
      #     REMOTE_USER: ${{ secrets.PRODUCTION_USER }}
      #     TARGET: /var/www/production

      - name: Deployment placeholder
        run: echo "Add your production deployment steps here"
