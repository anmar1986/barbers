name: CI Pipeline

on:
  push:
    branches: [main, master, develop, 'BB-*']
  pull_request:
    branches: [main, master, develop]

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Detect Changes
  # ============================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      laravel: ${{ steps.filter.outputs.laravel }}
      react: ${{ steps.filter.outputs.react }}
      flutter: ${{ steps.filter.outputs.flutter }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for file changes
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            laravel:
              - '**.php'
              - 'composer.json'
              - 'composer.lock'
              - 'phpstan.neon'
              - 'phpunit.xml'
            react:
              - 'resources/js/**'
              - 'package.json'
              - 'package-lock.json'
              - 'vite.config.js'
              - 'eslint.config.js'
            flutter:
              - 'frontend/**'

  # ============================================
  # Laravel Jobs
  # ============================================
  laravel-lint:
    name: Laravel - Code Style
    needs: changes
    if: ${{ needs.changes.outputs.laravel == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          coverage: none
      - run: composer install --prefer-dist
      - run: vendor/bin/pint --test

  laravel-phpstan:
    name: Laravel - PHPStan
    needs: changes
    if: ${{ needs.changes.outputs.laravel == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          coverage: none
      - run: composer install --prefer-dist
      - run: composer phpstan

  laravel-security:
    name: Laravel - Security
    needs: changes
    if: ${{ needs.changes.outputs.laravel == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          coverage: none
      - run: composer audit --format=plain

  laravel-tests:
    name: Laravel - Tests
    needs: changes
    if: ${{ needs.changes.outputs.laravel == 'true' }}
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: kerrar_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: pdo_mysql, gd, imagick
          coverage: none
      - run: composer install --prefer-dist
      - name: Setup environment
        run: |
          if [ -f .env.example ]; then
            cp .env.example .env
          else
            echo "APP_KEY=" > .env
          fi
      - run: php artisan key:generate
      - name: Configure database
        run: |
          echo "DB_CONNECTION=mysql" >> .env
          echo "DB_HOST=127.0.0.1" >> .env
          echo "DB_PORT=3306" >> .env
          echo "DB_DATABASE=kerrar_test" >> .env
          echo "DB_USERNAME=root" >> .env
          echo "DB_PASSWORD=password" >> .env
      - run: php artisan migrate --force
      - run: php artisan test

  # ============================================
  # React Jobs
  # ============================================
  react-lint:
    name: React - ESLint
    needs: changes
    if: ${{ needs.changes.outputs.react == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Configure npm
        run: |
          npm config set fetch-retries 5
          npm config set fetch-retry-mintimeout 20000
          npm config set fetch-retry-maxtimeout 120000
      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit
        timeout-minutes: 10
      - run: npm run lint

  react-build:
    name: React - Build
    needs: changes
    if: ${{ needs.changes.outputs.react == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Configure npm
        run: |
          npm config set fetch-retries 5
          npm config set fetch-retry-mintimeout 20000
          npm config set fetch-retry-maxtimeout 120000
      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit
        timeout-minutes: 10
      - run: npm run build

  react-security:
    name: React - Security
    needs: changes
    if: ${{ needs.changes.outputs.react == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Configure npm
        run: |
          npm config set fetch-retries 5
          npm config set fetch-retry-mintimeout 20000
          npm config set fetch-retry-maxtimeout 120000
      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit
        timeout-minutes: 10
      - run: npm audit --audit-level=high
        continue-on-error: true

  # ============================================
  # Flutter Jobs
  # ============================================
  flutter-analyze:
    name: Flutter - Analyze
    needs: changes
    if: ${{ needs.changes.outputs.flutter == 'true' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: stable
          cache: true
      - run: flutter pub get
      - run: dart format --set-exit-if-changed .
      - run: flutter analyze --no-fatal-infos

  flutter-tests:
    name: Flutter - Tests
    needs: changes
    if: ${{ needs.changes.outputs.flutter == 'true' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: stable
          cache: true
      - run: flutter pub get
      - run: flutter test

  flutter-build:
    name: Flutter - Build Android
    needs: [changes, flutter-analyze]
    if: ${{ needs.changes.outputs.flutter == 'true' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: stable
          cache: true
      - run: flutter pub get
      - run: echo "API_BASE_URL=https://api.example.com" > .env
      - run: flutter build apk --debug

  # ============================================
  # Final Status Check
  # ============================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs:
      - changes
      - laravel-lint
      - laravel-phpstan
      - laravel-security
      - laravel-tests
      - react-lint
      - react-build
      - react-security
      - flutter-analyze
      - flutter-tests
      - flutter-build
    if: always()
    steps:
      - name: Check CI Status
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY

          # Laravel status
          if [ "${{ needs.changes.outputs.laravel }}" == "true" ]; then
            if [ "${{ needs.laravel-tests.result }}" == "success" ] && \
               [ "${{ needs.laravel-phpstan.result }}" == "success" ] && \
               [ "${{ needs.laravel-lint.result }}" == "success" ]; then
              echo "| Laravel | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Laravel | :x: Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Laravel | :yellow_circle: Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          fi

          # React status
          if [ "${{ needs.changes.outputs.react }}" == "true" ]; then
            if [ "${{ needs.react-lint.result }}" == "success" ] && \
               [ "${{ needs.react-build.result }}" == "success" ]; then
              echo "| React | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| React | :x: Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| React | :yellow_circle: Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          fi

          # Flutter status
          if [ "${{ needs.changes.outputs.flutter }}" == "true" ]; then
            if [ "${{ needs.flutter-analyze.result }}" == "success" ] && \
               [ "${{ needs.flutter-build.result }}" == "success" ]; then
              echo "| Flutter | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Flutter | :x: Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Flutter | :yellow_circle: Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if any required job failed
        if: |
          (needs.changes.outputs.laravel == 'true' && (needs.laravel-tests.result == 'failure' || needs.laravel-phpstan.result == 'failure' || needs.laravel-lint.result == 'failure' || needs.laravel-security.result == 'failure')) ||
          (needs.changes.outputs.react == 'true' && (needs.react-lint.result == 'failure' || needs.react-build.result == 'failure' || needs.react-security.result == 'failure')) ||
          (needs.changes.outputs.flutter == 'true' && (needs.flutter-analyze.result == 'failure' || needs.flutter-tests.result == 'failure' || needs.flutter-build.result == 'failure'))
        run: exit 1
