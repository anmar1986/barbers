name: Flutter CI

# Manual trigger only - automatic checks run in ci.yml instead
on:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.35.7'
  WORKING_DIRECTORY: frontend

jobs:
  # ============================================
  # Static Analysis - Flutter Analyze
  # ============================================
  analyze:
    name: Static Analysis
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation (if needed)
        run: |
          if grep -q "build_runner" pubspec.yaml; then
            dart run build_runner build --delete-conflicting-outputs
          fi
        continue-on-error: true

      - name: Verify formatting
        run: dart format --set-exit-if-changed .

      - name: Analyze code
        run: flutter analyze --no-fatal-infos

  # ============================================
  # Tests
  # ============================================
  tests:
    name: Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation (if needed)
        run: |
          if grep -q "build_runner" pubspec.yaml; then
            dart run build_runner build --delete-conflicting-outputs
          fi
        continue-on-error: true

      - name: Run tests with coverage
        run: flutter test --coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: success()
        continue-on-error: true
        with:
          files: ${{ env.WORKING_DIRECTORY }}/coverage/lcov.info
          flags: flutter
          name: flutter-coverage

  # ============================================
  # Build - Android
  # ============================================
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: [analyze]
    timeout-minutes: 15
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17 (Required for Flutter 3.35)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Install Android SDK Components (API 34 for Flutter 3.35)
        run: |
          # Flutter 3.35 requires Android SDK Command-line Tools 12.0+, API 34/35, and Build Tools 34+
          flutter doctor -v
          
          # Update SDK manager to latest
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --update || true
          
          # Install required components for Flutter 3.35
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install \
            "cmdline-tools;latest" \
            "platform-tools" \
            "platforms;android-34" \
            "platforms;android-35" \
            "build-tools;34.0.0" \
            "build-tools;35.0.0" \
            "ndk;27.0.12077973" || true
          
          # Accept all licenses
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          
          # Verify installation
          flutter doctor -v

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation (if needed)
        run: |
          if grep -q "build_runner" pubspec.yaml; then
            dart run build_runner build --delete-conflicting-outputs
          fi
        continue-on-error: true

      - name: Prepare build environment
        run: |
          # Create .env file from example
          if [ -f .env.example ]; then
            cp .env.example .env
          else
            echo "API_BASE_URL=https://api.example.com" > .env
          fi
          
          # Ensure gradlew is executable (only if it exists)
          if [ -f android/gradlew ]; then
            chmod +x android/gradlew
          fi
          
          # Clean any previous builds
          flutter clean
          
          # Pre-download pub dependencies
          flutter pub get

      - name: Configure Gradle for CI
        run: |
          # Ensure gradle.properties has correct settings
          cat > android/gradle.properties << EOF
          org.gradle.jvmargs=-Xmx4G -XX:MaxMetaspaceSize=1G -XX:+HeapDumpOnOutOfMemoryError
          org.gradle.daemon=false
          org.gradle.parallel=true
          org.gradle.caching=true
          android.useAndroidX=true
          android.enableJetifier=true
          android.builder.sdkDownload=true
          EOF
          
          # Create local.properties with SDK location
          cat > android/local.properties << EOF
          sdk.dir=$ANDROID_HOME
          flutter.sdk=$FLUTTER_ROOT
          EOF

      - name: Pre-build diagnostics
        run: |
          echo "Flutter version:"
          flutter --version
          echo ""
          echo "Java version:"
          java -version
          echo ""
          echo "Android SDK location: $ANDROID_HOME"
          echo "Flutter SDK location: $FLUTTER_ROOT"
          echo ""
          echo "Checking .env file:"
          ls -la .env || echo ".env not found!"
          echo ""
          echo "Flutter doctor:"
          flutter doctor -v

      - name: Cache Gradle wrapper
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/wrapper
            ~/.gradle/caches
            ${{ env.WORKING_DIRECTORY }}/android/.gradle
          key: gradle-${{ runner.os }}-${{ hashFiles(format('{0}/android/gradle/wrapper/gradle-wrapper.properties', env.WORKING_DIRECTORY)) }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Build APK (debug)
        run: |
          echo "Starting Flutter build..."
          flutter build apk --debug --verbose 2>&1 | tee build.log || {
            echo "Build failed! Showing last 100 lines of output:"
            tail -100 build.log
            exit 1
          }
        timeout-minutes: 10
        continue-on-error: false

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-debug-${{ github.sha }}
          path: ${{ env.WORKING_DIRECTORY }}/build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 7

  # ============================================
  # Build - iOS (on macOS)
  # ============================================
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    needs: [analyze]
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation (if needed)
        run: |
          if grep -q "build_runner" pubspec.yaml; then
            dart run build_runner build --delete-conflicting-outputs
          fi
        continue-on-error: true

      - name: Create dummy .env file
        run: |
          echo "API_BASE_URL=https://api.example.com" > .env

      - name: Build iOS (no codesign)
        run: flutter build ios --no-codesign --debug

  # ============================================
  # Security - Dependency Audit
  # ============================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Check for outdated dependencies
        run: flutter pub outdated
        continue-on-error: true

      - name: Check for security advisories
        run: dart pub deps --json | head -100
        continue-on-error: true
